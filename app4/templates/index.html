{% extends "base.html" %}

{% block content %}
    <div class="sort_menu">
        <button class="btn btn-secondary dropdown-toggle" type="button" id="sort_menu_button" data-bs-toggle="dropdown" aria-expanded="false">
            Sort Options
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <li><a class="dropdown_item" data-sort = "alpha_asc">Ascending Alphabetical</a></li>
            <li><a class="dropdown_item" data-sort = "alpha_desc">Descending Alphabetical</a></li>
            <li><a class="dropdown_item" data-sort = "price_asc">Ascending Price</a></li>
            <li><a class="dropdown_item" data-sort = "price_desc">Descending Price</a></li>
            <li><a class="dropdown_item" data-sort = "carbon_asc">Ascending Carbon Footprint</a></li>
            <li><a class="dropdown_item" data-sort = "carbon_desc">Descending Carbon Footprint </a></li>
        </ul>
    </div>
    <h1>Cafe Extra</h1>
    <ul id = "menu_list">
        {% for item in cafe_menu %}
        {% set recipe_for_item = (cafe_recipes | selectattr('item_id', 'equalto', item.id) | list).0 %}
        <li class = "menu_item" data-name = "{{ item.name }}" data-price = "{{ item.price }}" data-carbon_footprint = "{{ recipe_for_item.total_carbon_footprint if recipe_for_item}}">
                <a href = "{{url_for('singleProductPage', item = loop.index)}}">
                    <h3>{{ item.name }} </h3>
                </a>
                <p>Price: {{ item.price }}</p>
                <img src = "{{ url_for('static', filename = item.image) }}" alt = "{{ item.name }}" class = "cafe_menu_images" data-image_item_id = "{{ item.id }}" draggable="true"> 
                {% if recipe_for_item %}
                    <p>Carbon Footprint: {{ recipe_for_item.total_carbon_footprint }}</p>
                {% endif %}
                <p id = "description_container"></p>
            </li>
        {% endfor %}
    </ul>
    <div id = 'basket_drop_area' style = "border: 2px; background-color: bisque;" padding = 10px>
        <h2>Basket</h2>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            /* BASKET DRAG AND DROP */

            const images = document.querySelectorAll('.cafe_menu_images');
            const basket_drop = document.getElementById('basket_drop_area');
        
            images.forEach(img => {
                img.addEventListener('dragstart', (event) => {
                    event.dataTransfer.setData('text/plain', img.dataset.image_item_id);
                });
            });

            basket_drop.addEventListener('dragover', (event) => {
                event.preventDefault();
                //basket_drop.style.backgroundColor = '#eef';
            });

            /*
            basket_drop.addEventListener('dragleave', (event) => {
                basket_drop.style.backgroundColor = '#eef';
            });
            */
           basket_drop.addEventListener('drop', async () =>{
            //basket_drop.style.backgroundColor = '';
            const dropped_item_id = event.dataTransfer.getData('text/plain');

            const response = await fetch('/add_to_basket', {
                method: 'POST', 
                headers: {
                    'Content-type' : 'application/json',
                    'X-CSRFToken' : '{{ csrf_token }}'
                },
                body: JSON.stringify({item_id : dropped_item_id, quantity: 1})
            });

            if(response.ok){
                alert('Item added to basket');
            }
            else{
                alert('Unable to add item to basket');
            }
           });


           /* ------------------------------------------------------------------------------------------- */

           /* SORTING */
           
           const sorting_methods = document.querySelectorAll('.dropdown_item');

           sorting_methods.forEach(sort_method  =>{
            sort_method.addEventListener('click', (event) =>{
                const [sorting_method, order_method] = sort_method.dataset.sort.split('_');
                sort_menu(sorting_method, order_method);
            });
           });

           /* FUNCTIONS */

           function sort_menu(sorting_method, order_method){
            //I want to retreive all the names of the cafe_menu_items here and sort them in alphabetical  order
            const items_list = Array.from(document.querySelectorAll('#menu_list .menu_item'));
            const sorted_items_list = items_list.sort((a, b) =>{
                let a_val, b_val;

                if (sorting_method == 'alpha'){
                    a_val = a.dataset.name.toLowerCase();
                    b_val = b.dataset.name.toLowerCase();
                }
                else if (sorting_method == 'price'){
                    a_val = parseFloat(a.dataset.price);
                    b_val = parseFloat(b.dataset.price);
                }
                else if (sorting_method == 'carbon'){
                    a_val = parseFloat(a.dataset.carbon_footprint);
                    b_val = parseFloat(b.dataset.carbon_footprint);
                }

                if (order_method == 'asc'){
                    if(typeof(a_val, b_val) == "number"){
                        return a_val - b_val;
                    }
                    return a_val.localeCompare(b_val);
                }
                else if(order_method =='desc'){
                    if(typeof(a_val, b_val) == "number"){
                        return b_val - a_val;
                    }
                    return b_val.localeCompare(a_val);
                }

            });
            sorted_items_list.forEach(item => menu_list.appendChild(item)); 
            }


           /* ------------------------------------------------------------------------------------------- */


           /* DISPLAY DESCRIPTION WHEN HOVER */

            images.forEach (img =>{
                let description_container = null;
                let active_image = null;
                let fetch_controller = null;
                img.addEventListener('mouseover', async () =>{
                //let description_container = document.getElementById('description_container');
                const item_id = img.dataset.image_item_id;
                console.log("Hover over: ", item_id);

                if(fetch_controller){
                    fetch_controller.abort();
                }

                if (active_image){
                    active_image.remove();
                    active_image = null;
                }

                active_image = img;
                fetch_controller = new AbortController();
                try{
                    const response = await fetch('/get_item_description', {
                    method: 'POST',
                    headers: {
                        'Content-type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({item_id: item_id}), 
                    signal: fetch_controller.signal
                    });

                    data = await response.json();
                    if (response.ok && active_image == img){
                        console.log("The description: ", data.description);
                        description_container = document.createElement('div');
                        description_container.classList.add('item_description');
                        description_container.innerText = data.description;

                        img.parentElement.appendChild(description_container);
                    }
                }
                catch(error){
                    if (error.name !== 'AbortError') {
                        console.log("Fetch error:", error);
                    }
                }
                });

                img.addEventListener('mouseout', () => {
                    //let description_container = document.getElementById('description_container');
                    if(description_container){
                        description_container.remove();
                        description_container = null;
                    }
                    active_image = null;
                    if(fetch_controller){
                        fetch_controller.abort();
                        fetch_controller = null;
                    }
                });
            });
        });


    </script>
{% endblock %}




 <!-- Display the description of the image when hovered over 
      <script>
        document.addEventListener('DOMContentLoaded', function () {
            const images = document.querySelectorAll('.cafe_menu_images');
            images.forEach (img =>{
                img.addEventListener('mouseover', () =>{
                const item_name = img.dataset.name;
                });
            });
        });
    </script>
     -->